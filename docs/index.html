<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ksy to C</title>
        <link rel="stylesheet" href="https://unpkg.com/css-baseline/css/2.css">
    </head>
    <body>
    </body>
    <script type="module">
        import Yaml from 'https://esm.sh/yaml@2.4.3?target=es2022'
        // import * as Yaml from "https://deno.land/std@0.168.0/encoding/yaml.ts"
        // import * as Yaml from 'https://esm.sh/gh/jeff-hykin/kaitai-esm@5541b33/yaml.js'
        import { createEditor } from 'https://cdn.jsdelivr.net/gh/jeff-hykin/codemirror_esm@5244ce0d764ae905bb8c784415a5a2f205731008/helpers.js'
        import { cpp } from 'https://cdn.jsdelivr.net/gh/jeff-hykin/codemirror_esm@5244ce0d764ae905bb8c784415a5a2f205731008/@codemirror/lang-cpp.js'
        import { yaml } from 'https://cdn.jsdelivr.net/gh/jeff-hykin/codemirror_esm@5244ce0d764ae905bb8c784415a5a2f205731008/@codemirror/lang-yaml.js'
        import { throttle } from 'https://esm.sh/gh/jeff-hykin/good-js@1.18.2.0/source/flattened/throttle.js'
        
        import { ksyToC } from 'https://esm.sh/gh/jeff-hykin/kaitai-esm@master/helpers/ksyToC.js'
        var { html, passAlongProps } = await import("https://esm.sh/gh/jeff-hykin/elemental@0.6.5/main/deno.js?dev")
        
        const warningsDiv = html`<div style=${`
            height: 12rem;
            position: fixed;
            right: 0;
            bottom: 0;
            width: 50vw;
            background-color: gray;
            overflow: auto;
        `}/>`

        const cppEditor = createEditor({
            style: "width:50vw;height:100vh;overflow: auto;",
            language: cpp,
        })
        
        const yamlEditor = createEditor({
            style: "width:50vw;height:100vh;overflow: auto;",
            language: yaml,
            value: `
                meta:
                  id: gif
                  file-extension: gif
                  endian: le
                seq:
                  - id: header
                    type: header
                  - id: logical_screen
                    type: logical_screen
                types:
                  header:
                    seq:
                      - id: magic
                        contents: 'GIF'
                      - id: version
                        size: 3
                  logical_screen:
                    seq:
                      - id: image_width
                        type: u2
                      - id: image_height
                        type: u2
                      - id: flags
                        type: u1
                      - id: bg_color_index
                        type: u1
                      - id: pixel_aspect_ratio
                        type: u1
            `.replace(/\n                /g, "\n").slice(1),
            onInput: throttle(500, ({element, editor}, update)=>{
                try {
                    const c = element.value
                    const { code: cCode, warnings } = ksyToC(Yaml.parse(c))
                    cppEditor.value = cCode
                    warningsDiv.innerHTML = warnings.map(each=>`<span>${each}</span>`.replace(/\n/g,"<br>")).join("<br>")
                } catch (error) {
                    warningsDiv.innerHTML = error.message + "\n" + error.stack.replace(/\n/g,"<br>")
                }
            }),
        })
        
        document.body = html`<body display=flex>
            ${yamlEditor}
            ${cppEditor}
            ${warningsDiv}
        </body>`
    </script>
</html>